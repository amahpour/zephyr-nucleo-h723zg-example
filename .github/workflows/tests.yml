name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    
    steps:
      # ==================== ENVIRONMENT SETUP ====================
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            git cmake ninja-build gperf \
            ccache dfu-util device-tree-compiler wget \
            python3-dev python3-venv python3-tk \
            xz-utils file make gcc gcc-multilib g++-multilib \
            libsdl2-dev libmagic1
      
      - name: Cache Zephyr workspace
        uses: actions/cache@v4
        with:
          path: |
            ~/zephyrproject
            ~/zephyr-sdk*
          key: zephyr-${{ runner.os }}-v5
      
      - name: Setup Zephyr environment
        run: |
          python3 -m venv ~/zephyrproject/.venv
          source ~/zephyrproject/.venv/bin/activate
          pip install west
          
          # Initialize if not cached
          if [ ! -f ~/zephyrproject/zephyr/CMakeLists.txt ]; then
            west init ~/zephyrproject
          fi
          
          cd ~/zephyrproject
          
          # Update modules if any are missing (hal_stm32 has the STM32 pinctrl files)
          if [ ! -d modules/hal/stm32 ] || [ ! -d modules/hal/cmsis ] || [ ! -d modules/hal/cmsis_6 ]; then
            west update zephyr hal_stm32 cmsis cmsis_6
            west zephyr-export
            west packages pip --install
          fi
          
          # Install SDK if not cached (need both x86 for QEMU and ARM for nucleo)
          SDK_DIR=$(ls -d ~/zephyr-sdk-* 2>/dev/null | head -1)
          if [ -z "$SDK_DIR" ] || [ ! -d "$SDK_DIR/arm-zephyr-eabi" ] || [ ! -d "$SDK_DIR/x86_64-zephyr-elf" ]; then
            cd ~/zephyrproject/zephyr
            west sdk install -t x86_64-zephyr-elf -t arm-zephyr-eabi
          fi
      
      # ==================== UNIT TESTS ====================
      - name: Run unit tests (ztest)
        run: |
          source ~/zephyrproject/.venv/bin/activate
          export ZEPHYR_BASE=~/zephyrproject/zephyr
          cd ${{ github.workspace }}
          west twister -T tests/unit -p qemu_x86 -v
      
      # ==================== INTEGRATION TESTS ====================
      - name: Build QEMU application
        run: |
          source ~/zephyrproject/.venv/bin/activate
          export ZEPHYR_BASE=~/zephyrproject/zephyr
          cd ${{ github.workspace }}
          west build -b qemu_x86 app --pristine
      
      - name: Install Python test dependencies
        run: |
          pip install pytest pyserial
      
      - name: Run integration tests (pytest)
        run: |
          export ZEPHYR_BASE=~/zephyrproject/zephyr
          SDK_DIR=$(ls -d ~/zephyr-sdk-* 2>/dev/null | head -1)
          if [ -n "$SDK_DIR" ]; then
            export ZEPHYR_SDK_INSTALL_DIR=$SDK_DIR
          fi
          cd ${{ github.workspace }}
          pytest tests/integration/ -v
      
      # ==================== FIRMWARE BUILD ====================
      - name: Build nucleo_h723zg firmware
        run: |
          source ~/zephyrproject/.venv/bin/activate
          export ZEPHYR_BASE=~/zephyrproject/zephyr
          cd ${{ github.workspace }}
          west build -b nucleo_h723zg app --pristine
      
      # ==================== ARTIFACTS ====================
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            twister-out/
            build/zephyr/zephyr.elf
            build/zephyr/zephyr.bin
            build/zephyr/zephyr.hex
