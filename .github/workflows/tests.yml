name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    
    steps:
      # ==================== ENVIRONMENT SETUP ====================
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            git cmake ninja-build gperf \
            ccache dfu-util device-tree-compiler wget \
            python3-dev python3-venv python3-tk \
            xz-utils file make gcc gcc-multilib g++-multilib \
            libsdl2-dev libmagic1
      
      - name: Setup Zephyr environment
        run: |
          # Fresh setup every time (no caching - too fragile)
          python3 -m venv ~/zephyrproject/.venv
          source ~/zephyrproject/.venv/bin/activate
          pip install west
          
          west init ~/zephyrproject
          cd ~/zephyrproject
          west update zephyr hal_stm32 cmsis cmsis_6
          west zephyr-export
          west packages pip --install
          
          # Install SDK
          cd ~/zephyrproject/zephyr
          west sdk install -t x86_64-zephyr-elf arm-zephyr-eabi
          
          # Debug: verify SDK installation
          echo "=== SDK Install Location ==="
          ls -la ~/zephyr-sdk-* 2>/dev/null || echo "No SDK in ~/"
          ls -la ~/.local/zephyr-sdk-* 2>/dev/null || echo "No SDK in ~/.local/"
          echo "=== CMake Packages ==="
          ls -la ~/.cmake/packages/ 2>/dev/null || echo "No CMake packages"
          cat ~/.cmake/packages/Zephyr-sdk/* 2>/dev/null || echo "No Zephyr-sdk registration"
      
      # ==================== UNIT TESTS ====================
      - name: Run unit tests (ztest)
        run: |
          source ~/zephyrproject/.venv/bin/activate
          export ZEPHYR_BASE=~/zephyrproject/zephyr
          cd ${{ github.workspace }}
          west twister -T tests/unit -p qemu_x86 -v
      
      # ==================== INTEGRATION TESTS ====================
      - name: Build QEMU application
        run: |
          source ~/zephyrproject/.venv/bin/activate
          export ZEPHYR_BASE=~/zephyrproject/zephyr
          cd ${{ github.workspace }}
          west build -b qemu_x86 app --pristine
      
      - name: Install Python test dependencies
        run: pip install -r tests/integration/requirements.txt
      
      - name: Run integration tests (pytest)
        run: |
          export ZEPHYR_BASE=~/zephyrproject/zephyr
          cd ${{ github.workspace }}
          PYTHONPATH=tests/integration pytest tests/integration/ \
            --config=tests/integration/configs/virtual.yaml -v
      
      # ==================== FIRMWARE BUILD ====================
      - name: Build nucleo_h723zg firmware
        run: |
          source ~/zephyrproject/.venv/bin/activate
          export ZEPHYR_BASE=~/zephyrproject/zephyr
          cd ${{ github.workspace }}
          west build -b nucleo_h723zg app --pristine
      
      # ==================== ARTIFACTS ====================
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            twister-out/
            build/zephyr/zephyr.elf
            build/zephyr/zephyr.bin
            build/zephyr/zephyr.hex
