name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  unit-tests:
    name: Unit Tests (Zephyr ztest)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git cmake ninja-build gperf \
            ccache dfu-util device-tree-compiler wget \
            python3-dev python3-venv python3-tk \
            xz-utils file make gcc gcc-multilib g++-multilib \
            libsdl2-dev libmagic1
      
      - name: Cache Zephyr workspace
        uses: actions/cache@v4
        with:
          path: |
            ~/zephyrproject
            ~/zephyr-sdk*
          key: zephyr-${{ runner.os }}-v2
          restore-keys: |
            zephyr-${{ runner.os }}-
      
      - name: Setup Zephyr environment
        run: |
          python3 -m venv ~/zephyrproject/.venv
          source ~/zephyrproject/.venv/bin/activate
          pip install west
          
          # Only initialize if not cached
          if [ ! -f ~/zephyrproject/zephyr/CMakeLists.txt ]; then
            west init ~/zephyrproject
            cd ~/zephyrproject
            west update zephyr
            west zephyr-export
            west packages pip --install
          fi
          
          # Only install SDK if not cached
          SDK_DIR=$(ls -d ~/zephyr-sdk-* 2>/dev/null | head -1)
          if [ -z "$SDK_DIR" ] || [ ! -d "$SDK_DIR/x86_64-zephyr-elf" ]; then
            cd ~/zephyrproject/zephyr
            west sdk install -t x86_64-zephyr-elf
          fi
      
      - name: Run unit tests
        run: |
          source ~/zephyrproject/.venv/bin/activate
          export ZEPHYR_BASE=~/zephyrproject/zephyr
          cd ${{ github.workspace }}
          west twister -T tests/unit -p qemu_x86 -v
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: twister-results
          path: twister-out/

  integration-tests:
    name: Integration Tests (pytest)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git cmake ninja-build gperf \
            ccache dfu-util device-tree-compiler wget \
            python3-dev python3-venv python3-tk \
            xz-utils file make gcc gcc-multilib g++-multilib \
            libsdl2-dev libmagic1
      
      - name: Cache Zephyr workspace
        uses: actions/cache@v4
        with:
          path: |
            ~/zephyrproject
            ~/zephyr-sdk*
          key: zephyr-${{ runner.os }}-v2
          restore-keys: |
            zephyr-${{ runner.os }}-
      
      - name: Setup Zephyr environment
        run: |
          python3 -m venv ~/zephyrproject/.venv
          source ~/zephyrproject/.venv/bin/activate
          pip install west
          
          # Only initialize if not cached
          if [ ! -f ~/zephyrproject/zephyr/CMakeLists.txt ]; then
            west init ~/zephyrproject
            cd ~/zephyrproject
            west update zephyr
            west zephyr-export
            west packages pip --install
          fi
          
          # Only install SDK if not cached
          SDK_DIR=$(ls -d ~/zephyr-sdk-* 2>/dev/null | head -1)
          if [ -z "$SDK_DIR" ] || [ ! -d "$SDK_DIR/x86_64-zephyr-elf" ]; then
            cd ~/zephyrproject/zephyr
            west sdk install -t x86_64-zephyr-elf
          fi
      
      - name: Build application
        run: |
          source ~/zephyrproject/.venv/bin/activate
          export ZEPHYR_BASE=~/zephyrproject/zephyr
          cd ${{ github.workspace }}
          west build -b qemu_x86 app --pristine
      
      - name: Install Python test dependencies
        run: |
          pip install pytest pyserial
      
      - name: Run integration tests
        run: |
          export ZEPHYR_BASE=~/zephyrproject/zephyr
          # Find SDK directory (version may vary)
          SDK_DIR=$(ls -d ~/zephyr-sdk-* 2>/dev/null | head -1)
          if [ -n "$SDK_DIR" ]; then
            export ZEPHYR_SDK_INSTALL_DIR=$SDK_DIR
          fi
          cd ${{ github.workspace }}
          pytest tests/integration/ -v
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-results
          path: |
            .pytest_cache/
            tests/integration/.pytest_cache/
